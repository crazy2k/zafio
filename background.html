<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Un poco de background &mdash; Zafio v0.1 documentation</title>
    <link rel="stylesheet" href="static/default.css" type="text/css" />
    <link rel="stylesheet" href="static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '#',
        VERSION:     '0.1',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="static/jquery.js"></script>
    <script type="text/javascript" src="static/doctools.js"></script>
    <script type="text/javascript" src="_static/translations.js"></script>
    <link rel="top" title="Zafio v0.1 documentation" href="index.html" />
    <link rel="next" title="Decisiones de diseño" href="design.html" />
    <link rel="prev" title="Documentación de Zafio" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="Índice General"
             accesskey="I">índice</a></li>
        <li class="right" >
          <a href="design.html" title="Decisiones de diseño"
             accesskey="N">siguiente</a> |</li>
        <li class="right" >
          <a href="index.html" title="Documentación de Zafio"
             accesskey="P">anterior</a> |</li>
        <li><a href="index.html">Zafio v0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="un-poco-de-background">
<h1>Un poco de <em>background</em><a class="headerlink" href="#un-poco-de-background" title="Enlazar permanentemente con este título">¶</a></h1>
<p>La idea de este documento no es brindar explicaciones exhaustivas ni
servir de referencia absoluta de ninguno de los temas necesarios para
poder encarar un proyecto como este. Se pretende, simplemente, ofrecer
un material de apoyo a otros documentos orientado a las necesidades de
este proyecto.</p>
<p>En consecuencia, se asume que el lector tiene conocimientos previos
acerca de la arquitectura IA-32, que ha tenido cierta experiencia
previa programando en algún dialecto de <em>assembly</em> para dicha
arquitectura y que está dispuesto a buscar en otros textos lo que no
pueda encontrar aquí.</p>
<p>La arquitectura en la que se basará este proyecto es la arquitectura
IA-32 de Intel, por lo que todos los detalles de bajo nivel se
orientarán a esta.</p>
<div class="section" id="la-secuencia-de-arranque">
<h2>La secuencia de arranque<a class="headerlink" href="#la-secuencia-de-arranque" title="Enlazar permanentemente con este título">¶</a></h2>
<p>En las computadoras compatibles con IBM PC, luego de encender la
máquina, tiene lugar la carga y ejecución de un programa, que reside en
una memoria especial de la computadora, llamado BIOS (<em>Basic
Input/Output System</em>). Generalmente, el BIOS realiza chequeos y/o
inicializaciones en el hardware y, si todo va bien, busca un
dispositivo del que pueda arrancar, siguiendo un orden de arranque que
especifica con qué dispositivo debe intentarse arrancar primero.</p>
<p>La forma que tiene el BIOS de verificar si puede arrancar de un cierto
dispositivo depende del estándar adoptado por este último. Para el
caso de los discos floppy o discos rígidos, la manera que tiene el BIOS
de saber si puede arrancar de ellos es verificando si los últimos dos
bytes del primer sector del dispositivo contienen la firma <tt class="docutils literal"><span class="pre">0xAA55</span></tt>.
<a class="footnote-reference" href="#id2" id="id1">[1]</a></p>
<p>Cuando encuentra que puede arrancar de uno de los dispositivos, entonces
copia desde él alguna pieza de código a memoria y comienza a ejecutarla.
En el caso de los discos floppy o rígidos, lo que se copia es el primer
sector, que suele tener un tamaño de 512 bytes, y se lo ubica a partir
de la dirección física <tt class="docutils literal"><span class="pre">0x7C00</span></tt>.</p>
<table class="docutils footnote" frame="void" id="id2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Para el caso de los CDs, por ejemplo, la especificación que se
sigue es otra.</td></tr>
</tbody>
</table>
<div class="section" id="el-bootloader">
<h3>El <em>bootloader</em><a class="headerlink" href="#el-bootloader" title="Enlazar permanentemente con este título">¶</a></h3>
<p>En casi cualquier caso, el código y los datos que carga el BIOS desde
el dispositivo suele ser escaso. Por ejemplo, los 512 bytes que se
cargan de un disco floppy o rígido no alcanzan para albergar un sistema
operativo con un mínimo de funcionalidad, por mucho que uno quiera.</p>
<p>Lo que suele ocurrir, entonces, es que esa pieza de código, de algún
modo, se ocupa de cargar el resto del sistema operativo en memoria.
Eso se puede lograr en un paso, siendo ese primer código el responsable
directo de la carga del resto del sistema operativo, o, más comúnmente,
en dos o más pasos encadenados, haciendo que el primer código cargue
otra pieza de código que sí se ocupe de cargar el sistema operativo o
cargue otra pieza de código que continúe con la cadena. A las piezas
de código que se ocupan de cargar el sistema operativo se las llama
<em>bootloader</em>.</p>
<p>El <em>bootloader</em> puede hacerse tan sofisticado como se quiera: desde una
pieza de código sencilla que copia una pieza fija de código del
dispositivo a memoria, a un cargador complejo, en varias etapas, capaz
de entender varios sistemas de archivos, preparar un entorno inicial
para el sistema, permitir elegir entre varios sistemas operativos
existentes para arrancar, etc.</p>
<p>Existe una cantidad de  <em>bootloaders</em> disponibles, cada uno de ellos
con características propias. Es común, entonces, utilizar uno de los
ya existentes, en lugar de escribir el propio, cuando alguno de ellos
se adapta a las necesidades del desarrollador.</p>
<div class="section" id="grub">
<h4>GRUB<a class="headerlink" href="#grub" title="Enlazar permanentemente con este título">¶</a></h4>
<p>Uno de los <em>bootloaders</em> más populares es GRUB. Las versiones de GRUB
suelen dividirse en las categorías &#8220;Legacy&#8221; (hasta 0.97) y GRUB 2. En
la actualidad, las versiones de GRUB más usadas, y sobre las que existe
más documentación, son las &#8220;Legacy&#8221;.</p>
<p>GRUB sigue una especificación llamada <em>Multiboot</em> <a class="reference internal" href="#multiboot">[Multiboot]</a>. Esta
especificación deja en claro, entre otras cosas, cuál es el estado de
la máquina una vez cargado el sistema operativo y qué información puede
pedirle este último al <em>bootloader</em> acerca del hardware.</p>
</div>
</div>
</div>
<div class="section" id="la-arquitectura">
<h2>La arquitectura<a class="headerlink" href="#la-arquitectura" title="Enlazar permanentemente con este título">¶</a></h2>
<div class="section" id="modos-de-operacion">
<h3>Modos de operación<a class="headerlink" href="#modos-de-operacion" title="Enlazar permanentemente con este título">¶</a></h3>
<p>La arquitectura IA-32 tiene los siguientes modos de operación:</p>
<ul>
<li><p class="first"><strong>Modo real</strong>: El modo real preserva el entorno del viejo Intel 8086,
con algunas extensiones, como las que permiten un cambio de modo. Es
el modo en el cual arranca cualquier máquina de esta arquitectura.</p>
<p>En este modo, los únicos registros de propósito &#8220;general&#8221; disponibles
son <tt class="docutils literal"><span class="pre">AX</span></tt>, <tt class="docutils literal"><span class="pre">BX</span></tt>, <tt class="docutils literal"><span class="pre">CX</span></tt>, <tt class="docutils literal"><span class="pre">DX</span></tt>, <tt class="docutils literal"><span class="pre">BP</span></tt>, <tt class="docutils literal"><span class="pre">SI</span></tt>, <tt class="docutils literal"><span class="pre">DI</span></tt> y <tt class="docutils literal"><span class="pre">SP</span></tt>,
todos de 16 bits.</p>
<p>Para el acceso a memoria, se utiliza segmentación. Las direcciones se
resuelven a partir de un registro de <img class="math" src="images/math/bda4b1a823ab94c43132c1f9be5b627d346d1a60.png" alt="segmento"/> y un <img class="math" src="images/math/7b1e0e7525cf41a63d86e97a71e329e9d647f1bc.png" alt="offset"/> a través
del siguiente cálculo: <img class="math" src="images/math/0b081b113753419883b7c448e755ba59e3a4ce69.png" alt="(segmento \cdot 16) + offset"/>. Es decir, los
registros de segmento sólo contienen información acerca del comienzo
de un segmento, pero no imponen un límite ni permisos. El espacio de
direcciones en modo real es de <img class="math" src="images/math/f6f4fb515f1d3a096a15a3bdce0db5aab3c5503f.png" alt="2^{20}"/> direcciones.</p>
</li>
<li><p class="first"><strong>Modo protegido</strong>: El modo protegido es &#8220;el modo de operación nativo
del procesador&#8221; de la arquitectura IA-32, según los manuales de
Intel. Este modo permite trabajar con un espacio de direcciones mucho
mayor y, en procesadores modernos, brinda mecanismos de protección de
memoria y anillos/niveles de ejecución.</p>
<p>En modo protegido se cuenta con los registros de próposito &#8220;general&#8221;
de 32 bits <tt class="docutils literal"><span class="pre">EAX</span></tt>, <tt class="docutils literal"><span class="pre">EBX</span></tt>, <tt class="docutils literal"><span class="pre">ECX</span></tt>, <tt class="docutils literal"><span class="pre">EDX</span></tt>, <tt class="docutils literal"><span class="pre">ESI</span></tt>, <tt class="docutils literal"><span class="pre">EDI</span></tt>,
<tt class="docutils literal"><span class="pre">EBP</span></tt> y <tt class="docutils literal"><span class="pre">ESP</span></tt>.</p>
<p>Los mecanismos de protección de memoria disponibles son segmentación
y páginación. Para la primera, los registros de segmento representan
selectores de segmento y proveen más información que los registros de
segmento en modo real.</p>
<p>Existe un pseudo-modo <strong>virtual-8086</strong>, que de momento no interesa.</p>
</li>
<li><p class="first"><strong>Modo de &#8220;gestión del sistema&#8221;</strong>: Por ahora no me interesa, pero
básicamente es un modo que permite atender mensajes o alarmas de las
que el sistema avisa a través de interrupciones.</p>
</li>
</ul>
<p>El siguiente gráfico muestra, para los modos mencionados, las maneras
de pasar de uno a otro:</p>
<p class="graphviz">
<img src="images/graphviz-799b8a3df95dde7a2dc82262b2767846fc1e776e.png" alt="digraph modos {
    &quot;Modo real&quot; -&gt; &quot;Modo protegido&quot; [label=&quot;PE=1&quot;];
    &quot;Modo real&quot; -&gt; &quot;Modo de 'gestión del sistema'&quot; [label=&quot;SMI#&quot;];
    &quot;Modo protegido&quot; -&gt; &quot;Modo real&quot; [label=&quot;Reset o PE=0&quot;];
    &quot;Modo protegido&quot; -&gt; &quot;Modo de 'gestión del sistema'&quot;
        [label=&quot;SMI#&quot;];
    &quot;Modo de 'gestión del sistema'&quot; -&gt; &quot;Modo real&quot;
        [label=&quot;Reset o RSM&quot;]
    &quot;Modo de 'gestión del sistema'&quot; -&gt; &quot;Modo protegido&quot;
        [label=&quot;RSM&quot;]
}" />
</p>
</div>
<div class="section" id="administracion-de-memoria">
<h3>Administración de memoria<a class="headerlink" href="#administracion-de-memoria" title="Enlazar permanentemente con este título">¶</a></h3>
</div>
<div class="section" id="segmentacion">
<h3>Segmentación<a class="headerlink" href="#segmentacion" title="Enlazar permanentemente con este título">¶</a></h3>
</div>
<div class="section" id="paginacion">
<h3>Paginación<a class="headerlink" href="#paginacion" title="Enlazar permanentemente con este título">¶</a></h3>
</div>
</div>
<div class="section" id="referencia-de-nasm">
<h2>Referencia de NASM<a class="headerlink" href="#referencia-de-nasm" title="Enlazar permanentemente con este título">¶</a></h2>
<div class="section" id="directivas-del-preprocesador">
<h3>Directivas del preprocesador<a class="headerlink" href="#directivas-del-preprocesador" title="Enlazar permanentemente con este título">¶</a></h3>
<dl class="describe">
<dt>
<tt class="descname">define A x</tt></dt>
<dt>
<tt class="descname">define f(x1, x2, ...) y</tt></dt>
<dd>Permite definir macros en una sola línea. Funciona de manera
similar a las macros de C, por lo que también posibilita crear
macros con &#8220;parámetros&#8221;.</dd></dl>

</div>
<div class="section" id="directivas-del-ensamblador">
<h3>Directivas del ensamblador<a class="headerlink" href="#directivas-del-ensamblador" title="Enlazar permanentemente con este título">¶</a></h3>
<dl class="describe">
<dt>
<tt class="descname">BITS m</tt></dt>
<dd><p>Indica que el código a continuación de la directiva debe generarse
para procesadores operando en modo de <tt class="docutils literal"><span class="pre">m</span></tt> bits, donde <tt class="docutils literal"><span class="pre">m</span></tt>
puede ser 16, 32 o 64.</p>
<p>Para el modo de salida <tt class="docutils literal"><span class="pre">bin</span></tt>, que es el que usamos para el
<em>bootloader</em>, se puede asumir por omisión que <tt class="docutils literal"><span class="pre">m</span></tt> es 16. Sin
embargo, siempre es buena práctica ser explícitos con esto, en
lugar de asumir valores por omisión.</p>
</dd></dl>

<dl class="describe">
<dt>
<tt class="descname">ORG addr</tt></dt>
<dd>Hace que NASM asuma que la dirección de memoria <tt class="docutils literal"><span class="pre">addr</span></tt> es la
dirección en la que ha sido cargado el programa. NASM utiliza esta
dirección como base para todas las referencias internas en una
sección de código.</dd></dl>

</div>
</div>
<div class="section" id="referencias">
<h2>Referencias<a class="headerlink" href="#referencias" title="Enlazar permanentemente con este título">¶</a></h2>
<table class="docutils citation" frame="void" id="multiboot" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[Multiboot]</a></td><td><a class="reference external" href="http://www.gnu.org/software/grub/manual/multiboot/multiboot.html">http://www.gnu.org/software/grub/manual/multiboot/multiboot.html</a></td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Contenidos</a></h3>
            <ul>
<li><a class="reference external" href="#">Un poco de <em>background</em></a><ul>
<li><a class="reference external" href="#la-secuencia-de-arranque">La secuencia de arranque</a><ul>
<li><a class="reference external" href="#el-bootloader">El <em>bootloader</em></a><ul>
<li><a class="reference external" href="#grub">GRUB</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference external" href="#la-arquitectura">La arquitectura</a><ul>
<li><a class="reference external" href="#modos-de-operacion">Modos de operación</a></li>
<li><a class="reference external" href="#administracion-de-memoria">Administración de memoria</a></li>
<li><a class="reference external" href="#segmentacion">Segmentación</a></li>
<li><a class="reference external" href="#paginacion">Paginación</a></li>
</ul>
</li>
<li><a class="reference external" href="#referencia-de-nasm">Referencia de NASM</a><ul>
<li><a class="reference external" href="#directivas-del-preprocesador">Directivas del preprocesador</a></li>
<li><a class="reference external" href="#directivas-del-ensamblador">Directivas del ensamblador</a></li>
</ul>
</li>
<li><a class="reference external" href="#referencias">Referencias</a></li>
</ul>
</li>
</ul>

            <h4>Tema anterior</h4>
            <p class="topless"><a href="index.html"
                                  title="Capítulo anterior">Documentación de Zafio</a></p>
            <h4>Próximo tema</h4>
            <p class="topless"><a href="design.html"
                                  title="Próximo capítulo">Decisiones de diseño</a></p>
            <h3>Esta página</h3>
            <ul class="this-page-menu">
              <li><a href="sources/background.txt"
                     rel="nofollow">Enseñar el código</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Búsqueda rápida</h3>
              <form class="search" action="search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Ir a" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Introduzca los términos de búsqueda o un módulo, clase o nombre de función.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="Índice General"
             >índice</a></li>
        <li class="right" >
          <a href="design.html" title="Decisiones de diseño"
             >siguiente</a> |</li>
        <li class="right" >
          <a href="index.html" title="Documentación de Zafio"
             >anterior</a> |</li>
        <li><a href="index.html">Zafio v0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2010, Pablo Antonio.
      Creado con <a href="http://sphinx.pocoo.org/">Sphinx</a> 0.6.4.
    </div>
  </body>
</html>